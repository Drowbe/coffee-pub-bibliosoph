<div class="window-encounter">
    <header class="window-encounter-header">
        <div class="window-encounter-header-content">
            <div class="window-encounter-header-icon">
                <i class="fa-solid fa-swords"></i>
            </div>
            <div class="window-encounter-header-title">{{title}}</div>
            <div class="window-encounter-header-controls">
                <button type="button" class="window-encounter-refresh-cache window-encounter-btn window-encounter-btn-secondary" {{#if cacheBuilding}}disabled{{/if}} title="Build or refresh the monster cache for faster searches">
                    <i class="fa-solid fa-database"></i> {{localize "coffee-pub-bibliosoph.quickEncounterRefreshCache-Label"}}
                </button>
            </div>
        </div>
        <div class="window-encounter-difficulty-badge-large {{difficultyClass}}" title="Current difficulty setting">
            <i class="fa-solid fa-dragon window-encounter-difficulty-icon"></i>
            <span class="window-encounter-difficulty-label">{{difficulty}}</span>
        </div>
    </header>

    <section class="window-encounter-configure">
        <h3 class="window-encounter-section-title">{{localize "coffee-pub-bibliosoph.quickEncounterConfigureEncounter-Label"}}</h3>
        <div class="window-encounter-odds-row">
            <label class="window-encounter-odds-label" for="{{appId}}-odds">{{localize "coffee-pub-bibliosoph.encounterOdds-Label"}} <span class="window-encounter-odds-current">{{oddsOfEncounter}}%</span></label>
        </div>
        <div class="window-encounter-odds-slider-row">
            <span class="window-encounter-odds-endpoint">0%</span>
            <input type="range" id="{{appId}}-odds" class="window-encounter-odds-slider" min="0" max="100" value="{{oddsOfEncounter}}" step="1" aria-label="Odds of encounter (0–100)" />
            <span class="window-encounter-odds-endpoint">100%</span>
        </div>
    </section>

    <section class="window-encounter-cr-panel">
        <h3 class="window-encounter-section-title">Challenge rating</h3>
        <div class="window-encounter-cr-boxes">
            <div class="window-encounter-cr-box" title="Party (hero) Challenge Rating">
                <span class="window-encounter-cr-box-label">HERO CR</span>
                <span class="window-encounter-cr-box-value">{{heroCRDisplay}}</span>
            </div>
            <div class="window-encounter-cr-box" title="{{#if monsterCRFromSelection}}Selected for deploy (effective CR){{else}}Current monsters on canvas{{/if}}">
                <span class="window-encounter-cr-box-label">MONSTER CR</span>
                <span class="window-encounter-cr-box-value">{{monsterCRDisplay}}</span>
            </div>
            <div class="window-encounter-cr-box window-encounter-cr-box-gap" title="Remaining CR to reach target">
                <span class="window-encounter-cr-box-label">MONSTER GAP</span>
                <span class="window-encounter-cr-box-value">{{monsterGapDisplay}}</span>
            </div>
            <div class="window-encounter-cr-box window-encounter-cr-box-target" title="Target encounter CR (from slider)">
                <span class="window-encounter-cr-box-label">ENCOUNTER CR</span>
                <span class="window-encounter-cr-box-value">{{encounterCRDisplay}}</span>
            </div>
        </div>

        <div class="window-encounter-cr-slider-row">
            <i class="fa-solid fa-rabbit window-encounter-slider-icon" title="Lower CR"></i>
            <input type="range" class="window-encounter-cr-slider" min="{{crSliderMin}}" max="{{crSliderMax}}" value="{{targetCRValue}}" step="0.25" aria-label="Target Encounter CR" />
            <i class="fa-solid fa-skull window-encounter-slider-icon" title="Higher CR"></i>
        </div>
        <div class="window-encounter-min-cr-row">
            <label class="window-encounter-min-cr-label" for="{{appId}}-min-cr">Minimum Monster CR <span class="window-encounter-min-cr-current">{{minCRDisplay}}</span></label>
            <div class="window-encounter-cr-slider-row">
                <input type="range" id="{{appId}}-min-cr" class="window-encounter-min-cr-slider" min="{{minCRSliderMin}}" max="{{minCRSliderMax}}" value="{{minCRValue}}" step="0.25" aria-label="Minimum creature CR (creatures below excluded)" />
            </div>
            <p class="window-encounter-min-cr-hint">Creatures below this CR are excluded from Recommend and Roll.</p>
        </div>
    </section>

    <section class="window-encounter-filters">
        <h3 class="window-encounter-section-title">Habitat</h3>
        <div class="window-encounter-habitats">
            {{#each habitats}}
            <button type="button" class="window-encounter-habitat {{#if selected}}active{{/if}}" data-habitat="{{name}}">{{name}}</button>
            {{/each}}
        </div>
        <div class="window-encounter-cache-status" title="{{cacheStatusTitle}}">
            {{#if cacheBuilding}}
                <span class="window-encounter-cache-building"><i class="fa-solid fa-spinner fa-spin"></i> {{cacheBuildingText}}</span>
            {{else}}
                <span class="window-encounter-cache-info">{{cacheStatusText}}</span>
            {{/if}}
        </div>
        <div class="window-encounter-action-buttons">
            <button type="button" class="window-encounter-roll window-encounter-btn" {{#if rollLoading}}disabled{{/if}} title="Roll for encounter using Global Encounter Settings (odds and dice); posts a card and may recommend monsters">
                <i class="fa-solid fa-dice"></i> Roll for Encounter
            </button>
            <button type="button" class="window-encounter-recommend window-encounter-btn" {{#if recommendLoading}}disabled{{/if}} title="{{#if recommendLoading}}Searching…{{else}}Search compendiums for matching monsters{{/if}}">
                <i class="fa-solid fa-magnifying-glass"></i> Recommend monsters
            </button>
        </div>
    </section>

    <section class="window-encounter-results">
        <h3 class="window-encounter-section-title">Matching results</h3>
        {{#if showSearchingSpinner}}
        <div class="window-encounter-results-loading" aria-busy="true">
            <i class="fa-solid fa-spinner fa-spin window-encounter-spinner"></i>
            <span class="window-encounter-loading-text">Searching compendiums…</span>
        </div>
        {{else if hasRecommendations}}
        <div class="window-encounter-results-grid">
            {{#each recommendations}}
            <div class="window-encounter-result-card {{#if selected}}selected{{/if}}{{#if count}} window-encounter-result-row-built{{/if}}" data-actor-id="{{id}}" data-count="{{count}}" title="{{#if count}}Part of built encounter — deploy below{{else}}Click to select for deploy{{/if}}">
                {{#if selected}}<span class="window-encounter-result-selected-badge" aria-hidden="true"><i class="fa-solid fa-check"></i></span>{{/if}}
                <img class="window-encounter-result-img" src="{{img}}" alt="{{name}}" />
                <div class="window-encounter-result-name">{{#if count}}{{count}} × {{/if}}{{name}}</div>
                <div class="window-encounter-result-cr">CR {{cr}}</div>
            </div>
            {{/each}}
        </div>
        {{else}}
        {{#if recommendAttempted}}
        <p class="window-encounter-results-empty">No monsters found. Try a different habitat or difficulty.</p>
        {{else}}
        <p class="window-encounter-results-empty">Set habitat and difficulty, then click <strong>Recommend monsters</strong>.</p>
        {{/if}}
        {{/if}}
    </section>

    <section class="window-encounter-deploy">
        <h3 class="window-encounter-section-title">Deploy</h3>
        <p class="window-encounter-deploy-hint">Click result cards to select (or use a built encounter). Click a pattern to deploy to the canvas.</p>
        <div class="window-encounter-deploy-options">
            <div class="window-encounter-deploy-patterns">
                {{#each deploymentPatterns}}
                <button type="button" class="window-encounter-deploy-pattern {{#if selected}}active{{/if}} {{#unless ../hasDeploySelection}}window-encounter-deploy-pattern-disabled{{/unless}}" data-pattern="{{value}}" {{#unless ../hasDeploySelection}}disabled{{/unless}} title="{{#if ../hasDeploySelection}}Deploy using {{label}} pattern{{else}}Select monsters above first{{/if}}">{{label}}</button>
                {{/each}}
            </div>
            <label class="window-encounter-deploy-visible-label">
                <input type="checkbox" class="window-encounter-deploy-visible" {{#unless deploymentHidden}}checked{{/unless}} />
                <span>Visible</span>
            </label>
        </div>
    </section>
</div>
